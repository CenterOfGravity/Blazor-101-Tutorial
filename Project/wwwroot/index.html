<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Project</title>
    <base href="/" />
    <link href="css/app.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">
    <!-- If you add any scoped CSS files, uncomment the following to load them-->
    <link href="Project.styles.css" rel="stylesheet" />
</head>

<body>
    <div id="app">Loading...</div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="" class="reload">Reload</a>
        <a class="dismiss">ðŸ—™</a>
    </div>
    <script src="_framework/blazor.webassembly.js"></script>

    <script>
        width = function () {
            return window.innerWidth;
        };

        LocalStorageSetItem = (key, item) => {
            window.localStorage.setItem(key, item);
        };

        LocalStorageGetItem = (key) => {
            return window.localStorage.getItem(key);
        };

        LocalStorageRemoveItem = (key) => {
            window.localStorage.removeItem(key);
        };

        GetScrollLeft = (id) => {
            return document.getElementById(id).scrollLeft
        };

        SetScrollLeft = (id, value) => {
            document.getElementById(id).scrollLeft = value;
        };

        ElementClientWidth = (id) => {
            return document.getElementById(id).clientWidth;
        };

        ElementScrollWidth = (id) => {
            return document.getElementById(id).scrollWidth;
        };

        ElementoOffSetLeft = (ref) => {
            return ref.offsetLeft;
        };
    </script>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
        import { getAuth, setPersistence, createUserWithEmailAndPassword, sendEmailVerification, signInWithEmailAndPassword, browserLocalPersistence, browserSessionPersistence, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCYgYsyu5iJbNM47vZaCop2CVf8AJbyt8c",
            authDomain: "project-6ce9f.firebaseapp.com",
            projectId: "project-6ce9f",
            storageBucket: "project-6ce9f.appspot.com",
            messagingSenderId: "169185885455",
            appId: "1:169185885455:web:01b8b21000c6bf0981127a"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        // Initialize Firebase Authentication and get a reference to the service
        const auth = getAuth(app);

        var actionCodeSettings = {
            url: 'https://localhost:7152/'
        };

        window.CreateUserWithEmailAndPassword = async function(email, password)
        {
            var IsSignedIn = false;
            await createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // Signed in 
                    const user = userCredential.user;
                    IsSignedIn = true;
                    // ...
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    alert(errorMessage);
                    IsSignedIn = false;
                    // ..
                });
            password = "";
            return IsSignedIn;
        }

        window.SendEmailVerification = async function (ShouldSendAlert) {
            await sendEmailVerification(auth.currentUser, actionCodeSettings)
                .then(() => {
                    // Email verification sent!
                    // ...
                    if (ShouldSendAlert) {
                        alert("Verification email sent");
                    }
                }).catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    alert(errorMessage);
                    // ..
                });
        }

        window.SignInWithEmailAndPassword = async function (email, password, RememberMe) {
            // array[IsSignedIn --> [0], IsEmailVerified --> [1]]
            let array = [false, false];
            await setPersistence(auth, RememberMe ? browserLocalPersistence : browserSessionPersistence)
                .then(async function () {

                    await signInWithEmailAndPassword(auth, email, password)
                        .then((userCredential) => {
                            // Signed in
                            const user = userCredential.user;
                            array[0] = true;
                            array[1] = user.emailVerified;
                            // ...
                        });
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    array[0] = false;
                    alert(errorMessage);
                });
            return array
        }

        window.OnAuthStateChanged =  (DotNetObjRef) => {
            let name;
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in, see docs for a list of available properties
                    // https://firebase.google.com/docs/reference/js/firebase.User
                    const uid = user.uid;
                    name = user.displayName
                    // ...
                } else {
                    // User is signed out
                    // ...
                    name = "";
                }
                 DotNetObjRef.invokeMethodAsync('JSInvokableOnAuthStateChanged', name);
            });
           // return name
        }

        window.UpdateProfile = async function (name) {
            updateProfile(auth.currentUser, {
                displayName: name
            }).then(() => {
                // Profile updated!
                // ...
            }).catch((error) => {
                // An error occurred
                alert(error);
                // ...
            });
        }


        // Initialize Cloud Firestore and get a reference to the service
        const dbFS = getFirestore(app);

        window.FireStoreDBSetProduct = async function (
            Id, Category, Brand, Title,
            Description, DescrKeyPointsTitle, DescrKeyPointsInfo,
            Details, DetailsKeyPointsTitle, DetailsKeyPointsInfo,
            OriginalPrices, DiscountedPrices, Quantities,
            Colors, Sizes, ImgURLs) {

            const ProductInfo =
            {
                Category: Category,
                Brand: Brand,
                Title: Title,
                Description: Description,
                DescrKeyPointsTitle: DescrKeyPointsTitle,
                DescrKeyPointsInfo: DescrKeyPointsInfo,
                Details: Details,
                DetailsKeyPointsTitle: DetailsKeyPointsTitle,
                DetailsKeyPointsInfo: DetailsKeyPointsInfo,
                OriginalPrices: OriginalPrices,
                DiscountedPrices: DiscountedPrices,
                Quantities: Quantities,
                Colors: Colors,
                Sizes: Sizes,
                ImgURLs: ImgURLs
            };

            try {
                let docRef;
                if (!Id) {
                    docRef = await addDoc(collection(dbFS, Category), ProductInfo);
                } else {
                    await setDoc(doc(dbFS, Category, Id), ProductInfo);
                }

                alert("Item succesfully added to FireStore");

                return docRef.id;

            } catch (e) {
                alert("Error Adding document to FireStore: " + e);
                //  console.error("Error Adding document to FireStore: ", e);
            }

        }
    </script>
</body>

</html>
